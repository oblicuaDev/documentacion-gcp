"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[9084],{8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var i=t(6540);const s={},l=i.createContext(s);function o(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(l.Provider,{value:n},e.children)}},8728:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"funciones/ingest-task-from-billy","title":"\ud83d\udd17 ingest-task-from-billy (Cloud Function)","description":"Esta funci\xf3n es el Endpoint de Ingesta de Tareas. Es el \xfanico servicio que est\xe1 configurado con acceso p\xfablico (respetando las reglas CORS) y su \xfanica misi\xf3n es recibir la configuraci\xf3n de una tarea de cobro (ej. \\"enviar facturas de Siigo al usuario X\\") e iniciar la ejecuci\xf3n del Billy-workflow.","source":"@site/docs/funciones/ingest-task-from-billy.md","sourceDirName":"funciones","slug":"/funciones/ingest-task-from-billy","permalink":"/documentacion-gcp/docs/funciones/ingest-task-from-billy","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/funciones/ingest-task-from-billy.md","tags":[],"version":"current","frontMatter":{"id":"ingest-task-from-billy","title":"\ud83d\udd17 ingest-task-from-billy (Cloud Function)","sidebar_label":"Punto de Ingesta"},"sidebar":"billyGcpSidebar","previous":{"title":"Procesador Siigo","permalink":"/documentacion-gcp/docs/funciones/get-data-from-siigo"},"next":{"title":"Procesar y Enviar","permalink":"/documentacion-gcp/docs/funciones/process-and-send-message"}}');var s=t(4848),l=t(8453);const o={id:"ingest-task-from-billy",title:"\ud83d\udd17 ingest-task-from-billy (Cloud Function)",sidebar_label:"Punto de Ingesta"},r="Funci\xf3n ingest-task-from-billy",c={},a=[{value:"1. Detalles de Despliegue",id:"1-detalles-de-despliegue",level:2},{value:"2. Flujo de Control",id:"2-flujo-de-control",level:2},{value:"A. Entrada (Payload)",id:"a-entrada-payload",level:3},{value:"B. Proceso de Orquestaci\xf3n",id:"b-proceso-de-orquestaci\xf3n",level:3},{value:"C. \xc9xito y Errores",id:"c-\xe9xito-y-errores",level:3},{value:"3. C\xf3digo Fuente (Node.js)",id:"3-c\xf3digo-fuente-nodejs",level:2}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsxs)(n.h1,{id:"funci\xf3n-ingest-task-from-billy",children:["Funci\xf3n ",(0,s.jsx)(n.code,{children:"ingest-task-from-billy"})]})}),"\n",(0,s.jsxs)(n.p,{children:["Esta funci\xf3n es el ",(0,s.jsx)(n.strong,{children:"Endpoint de Ingesta de Tareas"}),'. Es el \xfanico servicio que est\xe1 configurado con acceso p\xfablico (respetando las reglas CORS) y su \xfanica misi\xf3n es recibir la configuraci\xf3n de una tarea de cobro (ej. "enviar facturas de Siigo al usuario X") e iniciar la ejecuci\xf3n del ',(0,s.jsx)(n.code,{children:"Billy-workflow"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"1-detalles-de-despliegue",children:"1. Detalles de Despliegue"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Tipo"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Cloud Run Service (Node.js)"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Funci\xf3n HTTP."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"northamerica-south1"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Desplegada en esta regi\xf3n."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"https://ingest-task-from-billy-985640295677.northamerica-south1.run.app"})}),(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,s.jsx)(n.strong,{children:"Endpoint P\xfablico"})," (usado por la UI)."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Autenticaci\xf3n"})}),(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:["Acceso ",(0,s.jsx)(n.strong,{children:"No Autenticado"})]}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Permite el acceso desde el frontend (UI de Oblicua)."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"CORS"})}),(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:["Limitado al origen ",(0,s.jsx)(n.code,{children:"https://devbilly.oblicua.co"})]}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Restricci\xf3n de seguridad para peticiones de navegador."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.strong,{children:"Librer\xeda Clave"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"@google-cloud/workflows"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Utilizada para iniciar el Workflow."})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"2-flujo-de-control",children:"2. Flujo de Control"}),"\n",(0,s.jsx)(n.h3,{id:"a-entrada-payload",children:"A. Entrada (Payload)"}),"\n",(0,s.jsxs)(n.p,{children:["El cuerpo de la petici\xf3n ",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"POST"})})," contiene la configuraci\xf3n de la tarea seleccionada por el usuario, que se pasar\xe1 como argumento al Workflow."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="taskData (JSON de Entrada)"',children:'{\n  "data": {\n    "billy_user": "ID_DEL_USUARIO",\n    "integration": {\n      "platform": "GoogleSheets", // o SIIGO, CUENTI, etc.\n      "link_drive": "URL_DE_LA_MATRIZ"\n    },\n    "isTest": false\n    // Otros filtros de canal y tono\n  }\n}\n\n'})}),"\n",(0,s.jsx)(n.h3,{id:"b-proceso-de-orquestaci\xf3n",children:"B. Proceso de Orquestaci\xf3n"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Validaci\xf3n:"})," Se verifica que el m\xe9todo sea ",(0,s.jsx)(n.code,{children:"POST"})," y que el payload contenga el objeto ",(0,s.jsx)(n.code,{children:"data"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Manejo de CORS:"})," Responde a peticiones ",(0,s.jsx)(n.code,{children:"OPTIONS"})," y establece los encabezados de ",(0,s.jsx)(n.code,{children:"Access-Control"})," para permitir que el ",(0,s.jsx)(n.em,{children:"frontend"})," de Oblicua interact\xfae con la funci\xf3n."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Inicio del Workflow:"})," Utiliza el cliente ",(0,s.jsx)(n.code,{children:"ExecutionsClient"})," para iniciar el ",(0,s.jsx)(n.code,{children:"Billy-workflow"})," con el objeto ",(0,s.jsx)(n.code,{children:"taskData"})," como argumento (",(0,s.jsx)(n.code,{children:"argument: JSON.stringify(taskData)"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"c-\xe9xito-y-errores",children:"C. \xc9xito y Errores"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Respuesta 202 (Accepted):"})," Devuelve inmediatamente una respuesta 202 con el ID de la ejecuci\xf3n del Workflow, sin esperar a que el proceso de cobro termine."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Permisos:"})," La Cuenta de Servicio de esta funci\xf3n debe tener el rol ",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"Workflows Invoker"})})," para poder iniciar la ejecuci\xf3n del ",(0,s.jsx)(n.code,{children:"Billy-workflow"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"3-c\xf3digo-fuente-nodejs",children:"3. C\xf3digo Fuente (Node.js)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:'title="index.js"',children:"const functions = require('@google-cloud/functions-framework');\nconst { ExecutionsClient } = require('@google-cloud/workflows').v1;\n\n// --- Configuraci\xf3n ---\nconst client = new ExecutionsClient();\nconst project = 'billy-473802';\nconst location = 'northamerica-south1';\nconst workflow = 'Billy-workflow';\nconst ALLOWED_ORIGIN = '[https://devbilly.oblicua.co](https://devbilly.oblicua.co)';\n// --- Fin de la Configuraci\xf3n ---\n\nfunctions.http('ingestTask', async (req, res) => {\n    // --- L\xf3gica para manejar CORS ---\n    res.set('Access-Control-Allow-Origin', ALLOWED_ORIGIN);\n    res.set('Access-Control-Allow-Credentials', 'true');\n\n    if (req.method === 'OPTIONS') {\n        res.set('Access-Control-Allow-Methods', 'POST');\n        res.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n        res.set('Access-Control-Max-Age', '3600');\n        res.status(204).send('');\n        return;\n    }\n    // --- Fin de la L\xf3gica para manejar CORS ---\n\n    if (req.method !== 'POST' || !req.body) {\n        return res.status(400).send('Bad Request: Se requiere un cuerpo JSON en una solicitud POST.');\n    }\n\n    // Se lee directamente de req.body.data\n    const taskData = req.body.data;\n    if (!taskData) {\n        return res.status(400).send('Bad Request: El formato del JSON es incorrecto. No se encontr\xf3 el objeto \"data\".');\n    }\n    \n    console.log(`Tarea recibida para el usuario de Billy: ${taskData.billy_user}`);\n    console.log(`Link de Drive: ${taskData.link_drive}`);\n    console.log(`Es una prueba (isTest): ${taskData.isTest}`);\n\n    try {\n        const [execution] = await client.createExecution({\n            parent: client.workflowPath(project, location, workflow),\n            execution: {\n                argument: JSON.stringify(taskData),\n            },\n        });\n        console.log(`Workflow iniciado con \xe9xito. ID de ejecuci\xf3n: ${execution.name}`);\n        res.status(202).send({ message: 'Task accepted', executionId: execution.name });\n    } catch (error) {\n        console.error('Error al iniciar el workflow:', error);\n        res.status(500).send('Error Interno del Servidor al iniciar el workflow.');\n    }\n});\n"})})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);