"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[4100],{7983:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"funciones/save-user-credentials","title":"\ud83d\udd12 save-user-credentials (Cloud Function)","description":"Esta funci\xf3n es el Endpoint de Gesti\xf3n de Secretos de Billy GCP. Su \xfanica responsabilidad es recibir credenciales de integraci\xf3n (ej. access_key de Siigo) enviadas desde la interfaz de usuario de Oblicua y almacenarlas de forma segura en Google Cloud Secret Manager.","source":"@site/docs/funciones/save-user-credentials.md","sourceDirName":"funciones","slug":"/funciones/save-user-credentials","permalink":"/documentacion-gcp/docs/funciones/save-user-credentials","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/funciones/save-user-credentials.md","tags":[],"version":"current","frontMatter":{"id":"save-user-credentials","title":"\ud83d\udd12 save-user-credentials (Cloud Function)","sidebar_label":"Guardar Credenciales"},"sidebar":"billyGcpSidebar","previous":{"title":"Procesar y Enviar","permalink":"/documentacion-gcp/docs/funciones/process-and-send-message"},"next":{"title":"Orquestaci\xf3n Central","permalink":"/documentacion-gcp/docs/orquestacion/billy-workflow"}}');var t=s(4848),i=s(8453);const l={id:"save-user-credentials",title:"\ud83d\udd12 save-user-credentials (Cloud Function)",sidebar_label:"Guardar Credenciales"},c="Funci\xf3n save-user-credentials",a={},d=[{value:"1. Detalles de Despliegue y Seguridad",id:"1-detalles-de-despliegue-y-seguridad",level:2},{value:"2. Flujo de Datos y L\xf3gica",id:"2-flujo-de-datos-y-l\xf3gica",level:2},{value:"A. Entrada (Payload)",id:"a-entrada-payload",level:3},{value:"B. Proceso de Almacenamiento",id:"b-proceso-de-almacenamiento",level:3},{value:"C. Importancia de la Seguridad",id:"c-importancia-de-la-seguridad",level:3},{value:"3. C\xf3digo Fuente (Node.js)",id:"3-c\xf3digo-fuente-nodejs",level:2}];function o(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsxs)(n.h1,{id:"funci\xf3n-save-user-credentials",children:["Funci\xf3n ",(0,t.jsx)(n.code,{children:"save-user-credentials"})]})}),"\n",(0,t.jsxs)(n.p,{children:["Esta funci\xf3n es el ",(0,t.jsx)(n.strong,{children:"Endpoint de Gesti\xf3n de Secretos"})," de Billy GCP. Su \xfanica responsabilidad es recibir credenciales de integraci\xf3n (ej. ",(0,t.jsx)(n.code,{children:"access_key"})," de Siigo) enviadas desde la interfaz de usuario de Oblicua y almacenarlas de forma segura en ",(0,t.jsx)(n.strong,{children:"Google Cloud Secret Manager"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["El dise\xf1o utiliza la funci\xf3n ",(0,t.jsx)(n.code,{children:"upsertSecret"})," para garantizar que si el secreto ya existe, simplemente se agrega una nueva versi\xf3n, manteniendo un historial de credenciales."]}),"\n",(0,t.jsx)(n.h2,{id:"1-detalles-de-despliegue-y-seguridad",children:"1. Detalles de Despliegue y Seguridad"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"Tipo"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Cloud Run Service (Node.js)"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Funci\xf3n HTTP."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"us-south1"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Desplegada en esta regi\xf3n."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"https://save-user-credentials-985640295677.us-south1.run.app"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,t.jsx)(n.strong,{children:"Endpoint P\xfablico"})," (usado por la UI)."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"Autenticaci\xf3n"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["Acceso ",(0,t.jsx)(n.strong,{children:"No Autenticado"})]}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["Permite el acceso desde el ",(0,t.jsx)(n.em,{children:"frontend"})," de Oblicua."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"CORS"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["Limitado al origen ",(0,t.jsx)(n.code,{children:"https://devbilly.oblicua.co"})]}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Restricci\xf3n de seguridad para peticiones de navegador."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"Permiso Cr\xedtico"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Secret Manager Secret Admin"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["La Cuenta de Servicio debe tener este rol para ",(0,t.jsx)(n.strong,{children:"crear"})," y ",(0,t.jsx)(n.strong,{children:"a\xf1adir versiones"})," a los secretos."]})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"2-flujo-de-datos-y-l\xf3gica",children:"2. Flujo de Datos y L\xf3gica"}),"\n",(0,t.jsx)(n.h3,{id:"a-entrada-payload",children:"A. Entrada (Payload)"}),"\n",(0,t.jsxs)(n.p,{children:["La funci\xf3n espera un ",(0,t.jsx)(n.code,{children:"POST"})," con la identificaci\xf3n del usuario, el servicio de integraci\xf3n y el objeto de credenciales."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="Cuerpo de la Petici\xf3n POST"',children:'{\n  "billy_user": "usuario-ejemplo-123",\n  "service": "SIIGO", // o CUENTI, ALLEGRA, etc.\n  "credentials": {\n    "username": "api_user",\n    "access_key": "XXXXX-XXXXX-SECRET-TOKEN",\n    "partner_id": "12345"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"b-proceso-de-almacenamiento",children:"B. Proceso de Almacenamiento"}),"\n",(0,t.jsxs)(n.p,{children:["*",(0,t.jsx)(n.strong,{children:"Construcci\xf3n del Nombre del Secreto:"})," Se genera din\xe1micamente el nombre del secreto en el formato: ",(0,t.jsx)(n.code,{children:"[servicio-min\xfasculas]-[billy_user]-credentials"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Ejemplo: Si ",(0,t.jsx)(n.code,{children:'service="SIIGO"'})," y ",(0,t.jsx)(n.code,{children:'billy_user="prueba"'}),", el secreto ser\xe1: ",(0,t.jsx)(n.code,{children:"siigo-prueba-credentials"}),".\n*",(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"upsertSecret"}),":"]})," Intenta crear el secreto. Si ya existe (",(0,t.jsx)(n.code,{children:"c\xf3digo 6 = ALREADY_EXISTS"}),"), simplemente agrega una nueva versi\xf3n con el nuevo ",(0,t.jsx)(n.em,{children:"payload"})," (objeto JSON de credenciales)."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"c-importancia-de-la-seguridad",children:"C. Importancia de la Seguridad"}),"\n",(0,t.jsxs)(n.p,{children:["Esta funci\xf3n es el punto m\xe1s sensible. Es cr\xedtico que la ",(0,t.jsx)(n.strong,{children:"validaci\xf3n de acceso (mediante JWT en producci\xf3n)"})," est\xe9 configurada en el entorno de producci\xf3n para garantizar que solo usuarios autenticados de Oblicua puedan invocar este ",(0,t.jsx)(n.em,{children:"endpoint"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"3-c\xf3digo-fuente-nodejs",children:"3. C\xf3digo Fuente (Node.js)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",metastring:'title="index.js"',children:"const functions = require('@google-cloud/functions-framework');\nconst { SecretManagerServiceClient } = require('@google-cloud/secret-manager');\n\nconst secretClient = new SecretManagerServiceClient();\nconst project = 'billy-473802';\nconst ALLOWED_ORIGIN = '[https://devbilly.oblicua.co](https://devbilly.oblicua.co)';\n\nasync function upsertSecret(secretName, payload) {\n    try {\n        await secretClient.createSecret({\n            parent: `projects/${project}`,\n            secretId: secretName,\n            secret: {\n                replication: {\n                    automatic: {},\n                },\n            },\n        });\n        console.log(`Secreto ${secretName} creado.`);\n    } catch (error) {\n        if (error.code !== 6) throw error; // 6 = ALREADY_EXISTS\n        console.log(`El secreto ${secretName} ya existe. Se a\xf1adir\xe1 una nueva versi\xf3n.`);\n    }\n    const [version] = await secretClient.addSecretVersion({\n        parent: `projects/${project}/secrets/${secretName}`,\n        payload: {\n            data: Buffer.from(JSON.stringify(payload), 'utf8'),\n        },\n    });\n    console.log(`Se a\xf1adi\xf3 la versi\xf3n ${version.name} al secreto ${secretName}.`);\n    return version;\n}\n\nfunctions.http('saveUserCredentials', async (req, res) => {\n    // --- L\xf3gica de CORS ---\n    res.set('Access-Control-Allow-Origin', ALLOWED_ORIGIN);\n    res.set('Access-Control-Allow-Credentials', 'true');\n\n    if (req.method === 'OPTIONS') {\n        res.set('Access-Control-Allow-Methods', 'POST');\n        res.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n        res.set('Access-Control-Max-Age', '3600');\n        res.status(204).send('');\n        return;\n    }\n\n    if (req.method !== 'POST') {\n        return res.status(405).send('Method Not Allowed');\n    }\n\n    const { billy_user, service, credentials } = req.body;\n\n    if (!billy_user || !service || !credentials) {\n        return res.status(400).send('Faltan par\xe1metros: se requiere billy_user, service, y credentials.');\n    }\n\n    const secretName = `${service.toLowerCase()}-${billy_user}-credentials`;\n\n    try {\n        await upsertSecret(secretName, credentials);\n        res.status(200).send({ message: `Credenciales para ${service} del usuario ${billy_user} guardadas correctamente.` });\n    } catch (error) {\n        console.error('Error al guardar el secreto:', error);\n        res.status(500).send('Error interno al guardar las credenciales.');\n    }\n});\n"})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var r=s(6540);const t={},i=r.createContext(t);function l(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);