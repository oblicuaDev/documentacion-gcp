"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[3419],{2773:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"funciones/get-data-from-siigo","title":"\ud83d\udd17 get-data-from-siigo (Cloud Function)","description":"Esta funci\xf3n act\xfaa como el Adaptador de Siigo dentro del proceso de ingesta. Su principal tarea es realizar la consulta de facturas pendientes a trav\xe9s de un script PHP intermediario, navegar la estructura anidada de la respuesta de Siigo y transformar los datos al esquema de mensaje est\xe1ndar de Billy GCP.","source":"@site/docs/funciones/get-data-from-siigo.md","sourceDirName":"funciones","slug":"/funciones/get-data-from-siigo","permalink":"/documentacion-gcp/docs/funciones/get-data-from-siigo","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/funciones/get-data-from-siigo.md","tags":[],"version":"current","frontMatter":{"id":"get-data-from-siigo","title":"\ud83d\udd17 get-data-from-siigo (Cloud Function)","sidebar_label":"Procesador Siigo"},"sidebar":"billyGcpSidebar","previous":{"title":"Procesador Google Sheets","permalink":"/documentacion-gcp/docs/funciones/get-data-from-sheets"},"next":{"title":"Punto de Ingesta","permalink":"/documentacion-gcp/docs/funciones/ingest-task-from-billy"}}');var i=t(4848),s=t(8453);const o={id:"get-data-from-siigo",title:"\ud83d\udd17 get-data-from-siigo (Cloud Function)",sidebar_label:"Procesador Siigo"},r="Funci\xf3n get-data-from-siigo",d={},l=[{value:"1. Detalles de Despliegue",id:"1-detalles-de-despliegue",level:2},{value:"2. Flujo de Datos y L\xf3gica",id:"2-flujo-de-datos-y-l\xf3gica",level:2},{value:"A. Entrada (Payload)",id:"a-entrada-payload",level:3},{value:"B. Mapeo de Campos Cr\xedticos",id:"b-mapeo-de-campos-cr\xedticos",level:3},{value:"C. Procesamiento de Respuesta",id:"c-procesamiento-de-respuesta",level:3},{value:"3. C\xf3digo Fuente (Node.js)",id:"3-c\xf3digo-fuente-nodejs",level:2}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsxs)(n.h1,{id:"funci\xf3n-get-data-from-siigo",children:["Funci\xf3n ",(0,i.jsx)(n.code,{children:"get-data-from-siigo"})]})}),"\n",(0,i.jsxs)(n.p,{children:["Esta funci\xf3n act\xfaa como el ",(0,i.jsx)(n.strong,{children:"Adaptador de Siigo"})," dentro del proceso de ingesta. Su principal tarea es realizar la consulta de facturas pendientes a trav\xe9s de un ",(0,i.jsx)(n.em,{children:"script"})," PHP intermediario, navegar la estructura anidada de la respuesta de Siigo y transformar los datos al esquema de mensaje est\xe1ndar de Billy GCP."]}),"\n",(0,i.jsx)(n.h2,{id:"1-detalles-de-despliegue",children:"1. Detalles de Despliegue"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Tipo"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Cloud Run Service (Node.js)"}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Funci\xf3n HTTP invocada por Workflows."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"europe-west1"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Desplegada en esta regi\xf3n (mencionado en el Workflow)."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"https://get-data-from-siigo-985640295677.europe-west1.run.app"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,i.jsx)(n.strong,{children:"Endpoint privado"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Autenticaci\xf3n"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Requiere ",(0,i.jsx)(n.strong,{children:"IAM"})]}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Solo invocable por la Cuenta de Servicio del ",(0,i.jsx)(n.code,{children:"Billy-workflow"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Dependencia Clave"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"axios"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Usada para realizar la petici\xf3n POST al ",(0,i.jsx)(n.em,{children:"script"})," intermediario."]})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"2-flujo-de-datos-y-l\xf3gica",children:"2. Flujo de Datos y L\xf3gica"}),"\n",(0,i.jsx)(n.h3,{id:"a-entrada-payload",children:"A. Entrada (Payload)"}),"\n",(0,i.jsxs)(n.p,{children:["Recibe la configuraci\xf3n de la tarea (",(0,i.jsx)(n.code,{children:"taskConfig"}),") y las credenciales de Secret Manager, tal como lo hace la funci\xf3n de Cuenti."]}),"\n",(0,i.jsx)(n.h3,{id:"b-mapeo-de-campos-cr\xedticos",children:"B. Mapeo de Campos Cr\xedticos"}),"\n",(0,i.jsxs)(n.p,{children:["La funci\xf3n ",(0,i.jsx)(n.code,{children:"transformSiigoInvoice"})," es responsable de la l\xf3gica de mapeo, utilizando ",(0,i.jsx)(n.em,{children:"optional chaining"})," para navegar las estructuras anidadas y obtener campos como tel\xe9fono y email del contacto principal del cliente. El mapeo se realiza de forma robusta para manejar estructuras de respuesta variables de Siigo."]}),"\n",(0,i.jsx)(n.h3,{id:"c-procesamiento-de-respuesta",children:"C. Procesamiento de Respuesta"}),"\n",(0,i.jsxs)(n.p,{children:["La respuesta del ",(0,i.jsx)(n.em,{children:"script"})," intermediario de Siigo se espera en un formato muy espec\xedfico y anidado: ",(0,i.jsx)(n.code,{children:"response.data[0].data.results"}),". Si la respuesta no es un arreglo v\xe1lido en esa ruta, el proceso genera un error."]}),"\n",(0,i.jsx)(n.h2,{id:"3-c\xf3digo-fuente-nodejs",children:"3. C\xf3digo Fuente (Node.js)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'title="index.js"',children:"const functions = require('@google-cloud/functions-framework');\nconst axios = require('axios');\n\n/**\n * Transforma una factura de formato SIIGO a nuestro formato est\xe1ndar.\n * @param {object} siigoInvoice - Una factura individual del API de SIIGO/PHP.\n * @returns {object} La factura en el formato que nuestro sistema entiende.\n */\nfunction transformSiigoInvoice(siigoInvoice) {\n    // Helpers para obtener datos de forma segura de objetos anidados\n    const getContact = (invoice) => invoice.customer?.details?.contacts?.[0] || {};\n    const getContactPhone = (invoice) => getContact(invoice).phone || {};\n\n    return {\n        'No._Factura': siigoInvoice.name, // ej: \"FV-3-60\"\n        'Fecha_de_vencimiento': siigoInvoice.payments?.[0]?.due_date || null,\n        'D\xedas_en_Mora': siigoInvoice.dias_en_mora || 0,\n        'Monto': siigoInvoice.balance,\n        'Fecha_creaci\xf3n': siigoInvoice.date,\n        'Raz\xf3n_social_cliente': siigoInvoice.customer?.details?.name?.[0] || null,\n        'Cel_Cliente': getContactPhone(siigoInvoice).number,\n        'email_Cliente': getContact(siigoInvoice).email,\n        'Indicativo_Cel_Cliente': getContactPhone(siigoInvoice).indicative,\n        'Nit_Cliente': siigoInvoice.customer?.details?.identification,\n    };\n}\n\n// --- Funci\xf3n Principal ---\n\nfunctions.http('getDataFromSiigo', async (req, res) => {\n    const { credentials, taskConfig } = req.body;\n\n    if (!credentials || !taskConfig) {\n        return res.status(400).send('Faltan par\xe1metros: se requieren credentials y taskConfig.');\n    }\n\n    try {\n        // 1. Construir la solicitud para el script PHP de SIIGO\n        const phpUrl = '[https://billy.oblicua.co/cuenti/siigo.php](https://billy.oblicua.co/cuenti/siigo.php)';\n        const phpPayload = {\n            username: credentials.username,\n            access_key: credentials.access_key,\n            partner_id: credentials.partner_id,\n            test: taskConfig.isTest\n        };\n\n        // 2. Llamar al script PHP\n        console.log('Llamando al script PHP de SIIGO...');\n        const response = await axios.post(phpUrl, phpPayload);\n        \n        // 3. Navegar la respuesta anidada\n        const siigoInvoices = response.data?.[0]?.data?.results;\n\n        if (!Array.isArray(siigoInvoices)) {\n            throw new Error('La respuesta del script de SIIGO no contiene un arreglo de facturas en la ruta esperada.');\n        }\n        console.log(`Se recibieron ${siigoInvoices.length} facturas de SIIGO.`);\n\n        // 4. Transformar cada factura al formato est\xe1ndar\n        const standardizedInvoices = siigoInvoices.map(transformSiigoInvoice);\n\n        // 5. Devolver las facturas estandarizadas al workflow\n        res.status(200).json(standardizedInvoices);\n\n    } catch (error) {\n        console.error('Error al procesar datos de SIIGO:', error.response ? error.response.data : error.message);\n        res.status(500).send('Error interno al obtener datos de SIIGO.');\n    }\n});\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(6540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);