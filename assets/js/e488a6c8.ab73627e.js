"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[5432],{6601:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"funciones/get-data-from-cuenti","title":"\ud83d\udcbb get-data-from-cuenti (Cloud Function)","description":"Esta funci\xf3n Cloud Run act\xfaa como el adaptador de datos para el sistema de facturaci\xf3n Cuenti. Su principal responsabilidad es consultar las facturas pendientes a trav\xe9s de un script PHP intermediario y transformar el formato nativo de Cuenti al esquema de mensaje est\xe1ndar de Billy GCP.","source":"@site/docs/funciones/get-data-from-cuenti.md","sourceDirName":"funciones","slug":"/funciones/get-data-from-cuenti","permalink":"/documentacion-gcp/docs/funciones/get-data-from-cuenti","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/funciones/get-data-from-cuenti.md","tags":[],"version":"current","frontMatter":{"id":"get-data-from-cuenti","title":"\ud83d\udcbb get-data-from-cuenti (Cloud Function)","sidebar_label":"Procesador Cuenti"},"sidebar":"billyGcpSidebar","previous":{"title":"\ud83d\uddfa\ufe0f Arquitectura General","permalink":"/documentacion-gcp/docs/arquitectura-general"},"next":{"title":"Procesador Google Sheets","permalink":"/documentacion-gcp/docs/funciones/get-data-from-sheets"}}');var i=t(4848),r=t(8453);const s={id:"get-data-from-cuenti",title:"\ud83d\udcbb get-data-from-cuenti (Cloud Function)",sidebar_label:"Procesador Cuenti"},o="Funci\xf3n get-data-from-cuenti",c={},l=[{value:"1. Detalles de Despliegue",id:"1-detalles-de-despliegue",level:2},{value:"2. Flujo de Datos",id:"2-flujo-de-datos",level:2},{value:"3. C\xf3digo Fuente (Node.js)",id:"3-c\xf3digo-fuente-nodejs",level:2}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsxs)(n.h1,{id:"funci\xf3n-get-data-from-cuenti",children:["Funci\xf3n ",(0,i.jsx)(n.code,{children:"get-data-from-cuenti"})]})}),"\n",(0,i.jsxs)(n.p,{children:["Esta funci\xf3n Cloud Run act\xfaa como el ",(0,i.jsx)(n.strong,{children:"adaptador de datos"})," para el sistema de facturaci\xf3n Cuenti. Su principal responsabilidad es consultar las facturas pendientes a trav\xe9s de un ",(0,i.jsx)(n.em,{children:"script"})," PHP intermediario y transformar el formato nativo de Cuenti al esquema de mensaje est\xe1ndar de Billy GCP."]}),"\n",(0,i.jsx)(n.h2,{id:"1-detalles-de-despliegue",children:"1. Detalles de Despliegue"}),"\n",(0,i.jsxs)(n.p,{children:["Esta funci\xf3n se despliega como un servicio ",(0,i.jsx)(n.strong,{children:"Cloud Run"})," (aunque usa el ",(0,i.jsx)(n.em,{children:"framework"})," de funciones, se ejecuta como un servicio HTTP escalable)."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Tipo"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Cloud Run Service (Node.js)"}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Funci\xf3n HTTP disparada por Workflows."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"us-central1"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Para baja latencia con otros servicios de Norteam\xe9rica."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"https://get-data-from-cuenti-985640295677.us-central1.run.app"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,i.jsx)(n.strong,{children:"Endpoint privado"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Autenticaci\xf3n"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Requiere ",(0,i.jsx)(n.strong,{children:"IAM"})," (Solo la cuenta de servicio del Workflow puede invocarla)."]}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Seguridad estricta entre servicios internos."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Tiempo de Espera"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"300 segundos (5 minutos)"}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Configuraci\xf3n para ingesta de grandes lotes de facturas."})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"2-flujo-de-datos",children:"2. Flujo de Datos"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Entrada (Input):"})," Recibe un ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"POST"})})," del Workflow con la configuraci\xf3n de la tarea (",(0,i.jsx)(n.code,{children:"taskConfig"}),") y credenciales sensibles (",(0,i.jsx)(n.code,{children:"credentials"}),") obtenidas de Secret Manager."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Procesamiento:"})," La funci\xf3n llama al ",(0,i.jsx)(n.em,{children:"endpoint"})," PHP (",(0,i.jsx)(n.code,{children:"https://billy.oblicua.co/cuenti/cuenti.php"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Transformaci\xf3n Cr\xedtica:"})," La respuesta del script PHP es un ",(0,i.jsx)(n.strong,{children:"string JSON anidado"})," que debe ser decodificado (",(0,i.jsx)(n.code,{children:"JSON.parse"}),") antes del mapeo de campos."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Salida (Output):"})," Devuelve un arreglo de objetos JSON con el formato estandarizado, incluyendo la inicializaci\xf3n de los nuevos campos de control (",(0,i.jsx)(n.code,{children:"Etapa_actual"}),", ",(0,i.jsx)(n.code,{children:"Cobrador_..."}),"), directamente al Workflow."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-c\xf3digo-fuente-nodejs",children:"3. C\xf3digo Fuente (Node.js)"}),"\n",(0,i.jsx)(n.p,{children:"La l\xf3gica clave se encuentra en la manipulaci\xf3n de la respuesta anidada y la inclusi\xf3n de los nuevos campos en la transformaci\xf3n."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",metastring:'title="index.js"',children:"const functions = require('@google-cloud/functions-framework');\nconst axios = require('axios');\n\n/**\n * Transforma un objeto de factura con el formato de CUENTI al formato est\xe1ndar del sistema.\n * @param {object} cuentiInvoice - Un objeto de factura individual con la estructura devuelta por el script de CUENTI.\n * @returns {object} Un objeto de factura con la estructura estandarizada que el sistema espera.\n */\nfunction transformCuentiInvoice(cuentiInvoice) {\n    /**\n     * Convierte un timestamp de Unix (en milisegundos) a una fecha en formato YYYY-MM-DD.\n     * @param {number} timestamp - El timestamp a formatear.\n     * @returns {string|null} La fecha formateada o null si el timestamp no es v\xe1lido.\n     */\n    const formatDate = (timestamp) => {\n        if (!timestamp) return null;\n        return new Date(parseInt(timestamp, 10)).toISOString().split('T')[0];\n    };\n\n    // Mapea los campos de la respuesta de CUENTI a los nombres de clave est\xe1ndar\n    // que la funci\xf3n 'process-and-send-message' espera recibir.\n    return {\n        'No._Factura': cuentiInvoice.nFactura,\n        'Fecha_de_vencimiento': formatDate(cuentiInvoice.fecha_vencimiento),\n        'D\xedas_en_Mora': cuentiInvoice.dias_vencimiento ? parseInt(cuentiInvoice.dias_vencimiento, 10) * -1 : 0,\n        'Monto': cuentiInvoice.total_pendiente_pago,\n        'Fecha_creaci\xf3n': formatDate(cuentiInvoice.fecha_registro),\n        'Raz\xf3n_social_cliente': cuentiInvoice.nombre_cliente,\n        'Cel_Cliente': cuentiInvoice.movil,\n        'email_Cliente': cuentiInvoice.email,\n        'Indicativo_Cel_Cliente': cuentiInvoice.prefijo,\n        'Nit_Cliente': cuentiInvoice.identificacion,\n        'Etapa_actual': null,\n        'Cobrador_si_Grupo_Oblicua_SAS_no_es_el_cobrador_final': null\n    };\n}\n\n// --- Funci\xf3n Principal ---\n\n/**\n * Cloud Function activada por HTTP para obtener y procesar datos de facturas desde CUENTI.\n */\nfunctions.http('getDataFromCuenti', async (req, res) => {\n    // El workflow pasa las credenciales (obtenidas de Secret Manager) y la configuraci\xf3n de la tarea.\n    const { credentials, taskConfig } = req.body;\n\n    // Valida que la solicitud contenga los datos necesarios para operar.\n    if (!credentials || !taskConfig) {\n        return res.status(400).send('Faltan par\xe1metros: se requieren credentials y taskConfig.');\n    }\n\n    try {\n        // Define la URL del script PHP intermediario y construye el payload con las credenciales.\n        const phpUrl = '[https://billy.oblicua.co/cuenti/cuenti.php](https://billy.oblicua.co/cuenti/cuenti.php)';\n        const phpPayload = {\n            idEmpresa: credentials.idEmpresa,\n            token: credentials.token,\n            test: taskConfig.isTest\n        };\n\n        // Realiza la llamada HTTP POST al script PHP para obtener los datos de las facturas.\n        console.log('Llamando al script PHP de CUENTI...');\n        const response = await axios.post(phpUrl, phpPayload);\n        \n        // Extrae el string de datos JSON de la respuesta anidada del script PHP.\n        const cuentiInvoicesString = response.data?.[0]?.data;\n        if (!cuentiInvoicesString || typeof cuentiInvoicesString !== 'string') {\n            throw new Error('La respuesta del script de CUENTI no contiene un string de datos v\xe1lido.');\n        }\n\n        // Convierte el string JSON en un arreglo de objetos de factura utilizable.\n        const cuentiInvoices = JSON.parse(cuentiInvoicesString);\n\n        if (!Array.isArray(cuentiInvoices)) {\n            throw new Error('Los datos parseados de CUENTI no son un arreglo de facturas.');\n        }\n        console.log(`Se recibieron ${cuentiInvoices.length} facturas de CUENTI.`);\n\n        // Itera sobre cada factura recibida y la transforma al formato est\xe1ndar del sistema.\n        const standardizedInvoices = cuentiInvoices.map(transformCuentiInvoice);\n\n        // Devuelve la lista de facturas ya estandarizadas al workflow que invoc\xf3 la funci\xf3n.\n        res.status(200).json(standardizedInvoices);\n\n    } catch (error) {\n        // Captura y registra cualquier error ocurrido durante el proceso para facilitar la depuraci\xf3n.\n        console.error('Error al procesar datos de CUENTI:', error.response ? error.response.data : error.message);\n        res.status(500).send('Error interno al obtener datos de CUENTI.');\n    }\n});\n"})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var a=t(6540);const i={},r=a.createContext(i);function s(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);