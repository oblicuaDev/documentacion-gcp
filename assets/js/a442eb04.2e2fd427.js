"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[1635],{1245:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"orquestacion/billy-workflow","title":"\ud83e\udde9 Billy-workflow (Orquestaci\xf3n Central)","description":"El Billy-workflow es el componente de Orquestaci\xf3n Central del sistema. Su \xfanica responsabilidad es ejecutar una secuencia de pasos l\xf3gicos (obtenci\xf3n, transformaci\xf3n, y procesamiento) para cada lote de facturas, independientemente de la fuente de datos (Cuenti, Siigo, Google Sheets).","source":"@site/docs/orquestacion/Billy-workflow.md","sourceDirName":"orquestacion","slug":"/orquestacion/billy-workflow","permalink":"/documentacion-gcp/docs/orquestacion/billy-workflow","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/orquestacion/Billy-workflow.md","tags":[],"version":"current","frontMatter":{"id":"billy-workflow","title":"\ud83e\udde9 Billy-workflow (Orquestaci\xf3n Central)","sidebar_label":"Orquestaci\xf3n Central"},"sidebar":"billyGcpSidebar","previous":{"title":"Guardar Credenciales","permalink":"/documentacion-gcp/docs/funciones/save-user-credentials"},"next":{"title":"Esquema de Datos","permalink":"/documentacion-gcp/docs/pubsub-mensajeria"}}');var i=s(4848),l=s(8453);const r={id:"billy-workflow",title:"\ud83e\udde9 Billy-workflow (Orquestaci\xf3n Central)",sidebar_label:"Orquestaci\xf3n Central"},o="Billy-workflow",a={},c=[{value:"1. Detalles de Despliegue",id:"1-detalles-de-despliegue",level:2},{value:"2. Estructura y Flujo de Ejecuci\xf3n",id:"2-estructura-y-flujo-de-ejecuci\xf3n",level:2},{value:"Fase I: Inicializaci\xf3n y Definici\xf3n de Plataforma (<code>init</code> y <code>define_platform</code>)",id:"fase-i-inicializaci\xf3n-y-definici\xf3n-de-plataforma-init-y-define_platform",level:3},{value:"Fase II: Obtenci\xf3n de Facturas (<code>get_invoices_from_source</code>)",id:"fase-ii-obtenci\xf3n-de-facturas-get_invoices_from_source",level:3},{value:"Fase III: Procesamiento en Bucle (<code>process_invoices_loop</code>)",id:"fase-iii-procesamiento-en-bucle-process_invoices_loop",level:3},{value:"3. C\xf3digo YAML del Workflow",id:"3-c\xf3digo-yaml-del-workflow",level:2}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"billy-workflow",children:(0,i.jsx)(n.code,{children:"Billy-workflow"})})}),"\n",(0,i.jsxs)(n.p,{children:["El ",(0,i.jsx)(n.code,{children:"Billy-workflow"})," es el componente de ",(0,i.jsx)(n.strong,{children:"Orquestaci\xf3n Central"})," del sistema. Su \xfanica responsabilidad es ejecutar una secuencia de pasos l\xf3gicos (obtenci\xf3n, transformaci\xf3n, y procesamiento) para cada lote de facturas, independientemente de la fuente de datos (Cuenti, Siigo, Google Sheets)."]}),"\n",(0,i.jsx)(n.h2,{id:"1-detalles-de-despliegue",children:"1. Detalles de Despliegue"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Nombre"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"Billy-workflow"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Nombre oficial de la instancia."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"northamerica-south1"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Regi\xf3n donde se ejecuta la orquestaci\xf3n."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"https://workflowexecutions.googleapis.com/v1/projects/billy-473802/locations/northamerica-south1/workflows/Billy-workflow/executions"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:"Usado por cronjobs o triggers externos."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"Cuenta de Servicio"})}),(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.code,{children:"projects/billy-473802/serviceAccounts/985640295677-compute@developer.gserviceaccount.com"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Esta cuenta debe tener permisos ",(0,i.jsx)(n.strong,{children:"IAM"})," para acceder a ",(0,i.jsx)(n.strong,{children:"Secret Manager"})," e invocar los servicios de ",(0,i.jsx)(n.strong,{children:"Cloud Run"})," (",(0,i.jsx)(n.code,{children:"get-data-from-*"})," y ",(0,i.jsx)(n.code,{children:"process-and-send-message"}),")."]})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"2-estructura-y-flujo-de-ejecuci\xf3n",children:"2. Estructura y Flujo de Ejecuci\xf3n"}),"\n",(0,i.jsxs)(n.p,{children:["El workflow se divide en tres fases principales: ",(0,i.jsx)(n.strong,{children:"Inicializaci\xf3n"}),", ",(0,i.jsx)(n.strong,{children:"Obtenci\xf3n de Facturas"})," y ",(0,i.jsx)(n.strong,{children:"Procesamiento en Bucle"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"fase-i-inicializaci\xf3n-y-definici\xf3n-de-plataforma-init-y-define_platform",children:["Fase I: Inicializaci\xf3n y Definici\xf3n de Plataforma (",(0,i.jsx)(n.code,{children:"init"})," y ",(0,i.jsx)(n.code,{children:"define_platform"}),")"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"init"})}),": Asigna el payload de entrada (",(0,i.jsx)(n.code,{children:"args"}),") a la variable ",(0,i.jsx)(n.code,{children:"taskConfig"})," (que contiene el usuario de Billy y la configuraci\xf3n de la integraci\xf3n) e inicializa la lista ",(0,i.jsx)(n.code,{children:"invoices"})," vac\xeda."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"define_platform"})}),": Determina la plataforma de origen (",(0,i.jsx)(n.code,{children:"SIIGO"}),", ",(0,i.jsx)(n.code,{children:"CUENTI"}),", o ",(0,i.jsx)(n.code,{children:"GoogleSheets"}),"). Si la plataforma no se especifica en el ",(0,i.jsx)(n.code,{children:"taskConfig"}),", asume el valor por defecto: ",(0,i.jsx)(n.code,{children:'"GoogleSheets"'}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"fase-ii-obtenci\xf3n-de-facturas-get_invoices_from_source",children:["Fase II: Obtenci\xf3n de Facturas (",(0,i.jsx)(n.code,{children:"get_invoices_from_source"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Esta secci\xf3n utiliza una l\xf3gica ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"switch"})})," para elegir la rama de ejecuci\xf3n basada en la variable ",(0,i.jsx)(n.code,{children:"platform"}),"."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Plataforma"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Pasos Clave"}),(0,i.jsx)(n.th,{style:{textAlign:"left"},children:"Mecanismo de Seguridad"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"SIIGO / CUENTI"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["1. ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"get_*_credentials"})}),": Llama a Secret Manager para obtener el ",(0,i.jsx)(n.code,{children:"token"})," y ",(0,i.jsx)(n.code,{children:"idEmpresa"})," del usuario espec\xedfico. Si falla, genera un ",(0,i.jsx)(n.em,{children:"error de workflow"}),". 2. ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"call_*"})}),": Invoca la funci\xf3n Cloud Run respectiva (",(0,i.jsx)(n.code,{children:"get-data-from-siigo"})," o ",(0,i.jsx)(n.code,{children:"get-data-from-cuenti"}),") con las credenciales y la configuraci\xf3n."]}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Usa ",(0,i.jsx)(n.strong,{children:"Secret Manager API"})," y la ",(0,i.jsx)(n.strong,{children:"Autenticaci\xf3n OIDC"})," para invocar Cloud Run."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{style:{textAlign:"left"},children:(0,i.jsx)(n.strong,{children:"GoogleSheets"})}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["1. ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"call_sheets"})}),": Invoca la funci\xf3n ",(0,i.jsx)(n.code,{children:"get-data-from-sheets"})," directamente, usando el ",(0,i.jsx)(n.code,{children:"link_drive"})," del ",(0,i.jsx)(n.code,{children:"taskConfig"})," para obtener los datos."]}),(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:["Usa la ",(0,i.jsx)(n.strong,{children:"Autenticaci\xf3n OIDC"})," para invocar Cloud Run."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,i.jsx)(n.strong,{children:"Salida:"})," La respuesta HTTP de la funci\xf3n Cloud Run (que contiene el arreglo de facturas estandarizadas) se asigna a la variable global ",(0,i.jsx)(n.code,{children:"invoices"}),"."]}),(0,i.jsx)(n.td,{style:{textAlign:"left"}}),(0,i.jsx)(n.td,{style:{textAlign:"left"}})]})]})]}),"\n",(0,i.jsxs)(n.h3,{id:"fase-iii-procesamiento-en-bucle-process_invoices_loop",children:["Fase III: Procesamiento en Bucle (",(0,i.jsx)(n.code,{children:"process_invoices_loop"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Una vez que se tienen todas las facturas estandarizadas, el workflow itera sobre ellas individualmente:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Iteraci\xf3n (",(0,i.jsx)(n.code,{children:"for"}),"):"]})," Recorre el arreglo de facturas (",(0,i.jsx)(n.code,{children:"invoices.body"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Llamada al Handler (",(0,i.jsx)(n.code,{children:"call_process_and_send"}),"):"]})," Por cada factura (",(0,i.jsx)(n.code,{children:"invoice"}),"), invoca la funci\xf3n ",(0,i.jsx)(n.code,{children:"process-and-send-message"}),". Esta funci\xf3n contiene la l\xf3gica de ",(0,i.jsx)(n.strong,{children:"filtro de canales"})," y ",(0,i.jsx)(n.strong,{children:"tono de mensaje"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Manejo de Errores (",(0,i.jsx)(n.code,{children:"try/except"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Si la funci\xf3n de env\xedo es exitosa, se registra un mensaje de ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"log_success"})}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Si el env\xedo de una factura falla (",(0,i.jsx)(n.code,{children:"except"}),"), se registra un mensaje de ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"log_error"})})," y el workflow ",(0,i.jsx)(n.strong,{children:"contin\xfaa con la siguiente factura"})," (es decir, el fallo es manejado por elemento, sin detener todo el lote)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-c\xf3digo-yaml-del-workflow",children:"3. C\xf3digo YAML del Workflow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="Billy-workflow.yaml"',children:'main:\n  params:\n    - args\n  steps:\n    - init:\n        assign:\n          - taskConfig: ${args}\n          - invoices: []\n    - define_platform:\n        try:\n          assign:\n            - platform: ${taskConfig.integration.platform}\n        except:\n          assign:\n            - platform: "GoogleSheets"\n    - get_invoices_from_source:\n        switch:\n          - condition: ${platform == "SIIGO"}\n            steps:\n              - get_siigo_credentials:\n                  try:\n                    call: googleapis.secretmanager.v1.projects.secrets.versions.access\n                    args:\n                      name: ${"projects/billy-473802/secrets/siigo-" + taskConfig.billy_user + "-credentials/versions/latest"}\n                    result: siigoCreds\n                  except:\n                    as: e\n                    raise: ${"No se encontraron las credenciales para el usuario de SIIGO " + taskConfig.billy_user}\n              - call_siigo:\n                  call: http.post\n                  args:\n                    url: "[https://get-data-from-siigo-985640295677.europe-west1.run.app](https://get-data-from-siigo-985640295677.europe-west1.run.app)"\n                    auth:\n                      type: OIDC\n                    body:\n                      credentials: ${json.decode(siigoCreds.payload.data)}\n                      taskConfig: ${taskConfig}\n                  result: invoices\n          - condition: ${platform == "CUENTI"}\n            steps:\n              - get_cuenti_credentials:\n                  try:\n                    call: googleapis.secretmanager.v1.projects.secrets.versions.access\n                    args:\n                      name: ${"projects/billy-473802/secrets/cuenti-" + taskConfig.billy_user + "-credentials/versions/latest"}\n                    result: cuentiCreds\n                  except:\n                    as: e\n                    raise: ${"No se encontraron las credenciales para el usuario de CUENTI " + taskConfig.billy_user}\n              - call_cuenti:\n                  call: http.post\n                  args:\n                    url: [https://get-data-from-cuenti-985640295677.us-central1.run.app](https://get-data-from-cuenti-985640295677.us-central1.run.app)\n                    auth:\n                      type: OIDC\n                    body:\n                      credentials: ${json.decode(cuentiCreds.payload.data)}\n                      taskConfig: ${taskConfig}\n                  result: invoices\n          - condition: ${platform == "GoogleSheets"}\n            steps:\n              - call_sheets:\n                  call: http.post\n                  args:\n                    url: [https://get-data-from-sheets-985640295677.northamerica-south1.run.app](https://get-data-from-sheets-985640295677.northamerica-south1.run.app)\n                    auth:\n                      type: OIDC\n                    body:\n                      link_drive: ${taskConfig.link_drive}\n                      isTest: ${taskConfig.isTest}\n                  result: invoices\n    - process_invoices_loop:\n        for:\n          value: invoice\n          in: ${invoices.body}\n          steps:\n            - process_single_invoice:\n                try:\n                  steps:\n                    - call_process_and_send:\n                        call: http.post\n                        args:\n                          url: [https://process-and-send-message-985640295677.northamerica-south1.run.app](https://process-and-send-message-985640295677.northamerica-south1.run.app)\n                          auth:\n                            type: OIDC\n                          body:\n                            invoiceData: ${invoice}\n                            taskConfig: ${taskConfig}\n                        result: sendResult\n                    - log_success:\n                        call: sys.log\n                        args:\n                          text: ${"Resultado del env\xedo " + json.encode(sendResult.body)}\n                except:\n                  as: e\n                  steps:\n                    - log_error:\n                        call: sys.log\n                        args:\n                          text: ${"Error procesando factura " + e.message}\n    - final_step:\n        return: Proceso completado.\n'})})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var t=s(6540);const i={},l=t.createContext(i);function r(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);