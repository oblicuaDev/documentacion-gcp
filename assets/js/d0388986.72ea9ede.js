"use strict";(globalThis.webpackChunkbilly_gcp=globalThis.webpackChunkbilly_gcp||[]).push([[9337],{8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>i});var s=t(6540);const r={},a=s.createContext(r);function l(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(a.Provider,{value:n},e.children)}},8854:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"funciones/get-data-from-sheets","title":"\ud83d\udcc4 get-data-from-sheets (Cloud Function)","description":"Esta funci\xf3n es el Adaptador de Google Sheets dentro del proceso de ingesta de Billy GCP. Su prop\xf3sito es acceder a una matriz de facturas provista por el cliente, autenticarse usando una Cuenta de Servicio y transformar las filas en objetos JSON estandarizados para su posterior procesamiento.","source":"@site/docs/funciones/get-data-from-sheets.md","sourceDirName":"funciones","slug":"/funciones/get-data-from-sheets","permalink":"/documentacion-gcp/docs/funciones/get-data-from-sheets","draft":false,"unlisted":false,"editUrl":"https://github.com/oblicuaDev/documentacion-gcp/tree/main/docs/funciones/get-data-from-sheets.md","tags":[],"version":"current","frontMatter":{"id":"get-data-from-sheets","title":"\ud83d\udcc4 get-data-from-sheets (Cloud Function)","sidebar_label":"Procesador Google Sheets"},"sidebar":"billyGcpSidebar","previous":{"title":"Procesador Cuenti","permalink":"/documentacion-gcp/docs/funciones/get-data-from-cuenti"},"next":{"title":"Procesador Siigo","permalink":"/documentacion-gcp/docs/funciones/get-data-from-siigo"}}');var r=t(4848),a=t(8453);const l={id:"get-data-from-sheets",title:"\ud83d\udcc4 get-data-from-sheets (Cloud Function)",sidebar_label:"Procesador Google Sheets"},i="Funci\xf3n get-data-from-sheets",o={},d=[{value:"1. Detalles de Despliegue y Autenticaci\xf3n",id:"1-detalles-de-despliegue-y-autenticaci\xf3n",level:2},{value:"2. Flujo de Datos y L\xf3gica",id:"2-flujo-de-datos-y-l\xf3gica",level:2},{value:"A. Entrada (Payload)",id:"a-entrada-payload",level:3},{value:"B. Proceso de Lectura",id:"b-proceso-de-lectura",level:3},{value:"C. Validaci\xf3n y Filtrado",id:"c-validaci\xf3n-y-filtrado",level:3},{value:"3. C\xf3digo Fuente (Node.js)",id:"3-c\xf3digo-fuente-nodejs",level:2}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsxs)(n.h1,{id:"funci\xf3n-get-data-from-sheets",children:["Funci\xf3n ",(0,r.jsx)(n.code,{children:"get-data-from-sheets"})]})}),"\n",(0,r.jsxs)(n.p,{children:["Esta funci\xf3n es el ",(0,r.jsx)(n.strong,{children:"Adaptador de Google Sheets"})," dentro del proceso de ingesta de Billy GCP. Su prop\xf3sito es acceder a una matriz de facturas provista por el cliente, autenticarse usando una Cuenta de Servicio y transformar las filas en objetos JSON estandarizados para su posterior procesamiento."]}),"\n",(0,r.jsx)(n.h2,{id:"1-detalles-de-despliegue-y-autenticaci\xf3n",children:"1. Detalles de Despliegue y Autenticaci\xf3n"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Propiedad"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Valor"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Observaciones"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Tipo"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Cloud Run Service (Node.js)"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Funci\xf3n HTTP invocada por Workflows."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Regi\xf3n GCP"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"northamerica-south1"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Desplegada en esta regi\xf3n."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"URL de Invocaci\xf3n"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"https://get-data-from-sheets-985640295677.northamerica-south1.run.app"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,r.jsx)(n.strong,{children:"Endpoint privado"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Autenticaci\xf3n"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Requiere ",(0,r.jsx)(n.strong,{children:"IAM"})]}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Solo puede ser invocada por la Cuenta de Servicio del ",(0,r.jsx)(n.code,{children:"Billy-workflow"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Credenciales"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Obtenidas de ",(0,r.jsx)(n.strong,{children:"Secret Manager"})]}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Requiere acceso al secreto ",(0,r.jsx)(n.code,{children:"google-sheets-credentials"}),"."]})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"2-flujo-de-datos-y-l\xf3gica",children:"2. Flujo de Datos y L\xf3gica"}),"\n",(0,r.jsx)(n.h3,{id:"a-entrada-payload",children:"A. Entrada (Payload)"}),"\n",(0,r.jsxs)(n.p,{children:["La funci\xf3n espera un objeto JSON con el enlace del ",(0,r.jsx)(n.em,{children:"spreadsheet"})," y un ",(0,r.jsx)(n.em,{children:"flag"})," de prueba."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",metastring:'title="Cuerpo de la Petici\xf3n POST"',children:'{\n  "link_drive": "URL_COMPLETA_DEL_SPREADSHEET",\n  "isTest": false \n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"b-proceso-de-lectura",children:"B. Proceso de Lectura"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Autenticaci\xf3n:"})," Utiliza las credenciales de la Cuenta de Servicio obtenidas de Secret Manager."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Extracci\xf3n de ID:"})," El ID del ",(0,r.jsx)(n.em,{children:"spreadsheet"})," se extrae mediante una expresi\xf3n regular del ",(0,r.jsx)(n.code,{children:"link_drive"})," proporcionado."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rango de Lectura:"})," Se lee la hoja ",(0,r.jsx)(n.strong,{children:"'Facturas por cobrar'"})," en el rango ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"A:M"})}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mapeo:"})," La primera fila se usa como cabecera para mapear las filas restantes a objetos clave-valor."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"c-validaci\xf3n-y-filtrado",children:"C. Validaci\xf3n y Filtrado"}),"\n",(0,r.jsx)(n.p,{children:"La funci\xf3n aplica una validaci\xf3n estricta para asegurar la calidad de los datos antes de la ingesta:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Se filtran las filas donde las columnas de ",(0,r.jsx)(n.strong,{children:"Monto"})," o ",(0,r.jsx)(n.strong,{children:"Email"})," est\xe9n vac\xedas (columnas D y I respectivamente)."]}),"\n",(0,r.jsxs)(n.li,{children:["Si ",(0,r.jsx)(n.code,{children:"isTest"})," es ",(0,r.jsx)(n.code,{children:"true"}),", la salida se limita a las ",(0,r.jsx)(n.strong,{children:"primeras 5 filas"})," v\xe1lidas."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-c\xf3digo-fuente-nodejs",children:"3. C\xf3digo Fuente (Node.js)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",metastring:'title="index.js"',children:"const functions = require('@google-cloud/functions-framework');\nconst { google } = require('googleapis');\nconst { SecretManagerServiceClient } = require('@google-cloud/secret-manager');\n\nconst secretClient = new SecretManagerServiceClient();\n\n// Helper para obtener credenciales de la cuenta de servicio para Google Sheets\nasync function getSheetCredentials() {\n  const [version] = await secretClient.accessSecretVersion({\n    name: 'projects/billy-473802/secrets/google-sheets-credentials/versions/latest',\n  });\n  return JSON.parse(version.payload.data.toString('utf8'));\n}\n\nfunctions.http('getDataFromSheets', async (req, res) => {\n  const { link_drive, isTest } = req.body;\n\n  if (!link_drive) {\n    return res.status(400).send('Falta el par\xe1metro link_drive.');\n  }\n\n  try {\n    // Autenticaci\xf3n con Google Sheets\n    const serviceAccountCreds = await getSheetCredentials();\n    const auth = new google.auth.GoogleAuth({\n      credentials: serviceAccountCreds,\n      scopes: ['[https://www.googleapis.com/auth/spreadsheets.readonly](https://www.googleapis.com/auth/spreadsheets.readonly)'],\n    });\n    const sheets = google.sheets({ version: 'v4', auth });\n\n    // Extraer el ID del spreadsheet desde el link\n    const spreadsheetId = link_drive.match(/\\/d\\/(.+?)\\//)[1];\n    if (!spreadsheetId) {\n      return res.status(400).send('Link de Drive no v\xe1lido.');\n    }\n\n    // Leer los datos de la hoja\n    const response = await sheets.spreadsheets.values.get({\n      spreadsheetId,\n      range: \"'Facturas por cobrar'!A:M\", //\n    });\n\n    let rows = response.data.values || [];\n    const header = rows.shift(); // Quitar la cabecera\n\n    // Aplicar l\xedmite si es un test\n    if (isTest) {\n      rows = rows.slice(0, 5);\n    }\n    \n    // Validar y filtrar filas\n    const validRows = rows.filter(row => {\n      const amount = row[3]; \xa0// Columna D\n      const email = row[8]; \xa0 // Columna I\n      return amount && email; // Es obligatorio que tengan datos\n    }).map((row, index) => {\n      // Convertir el array de la fila a un objeto para f\xe1cil acceso\n      const rowObject = {};\n      header.forEach((key, i) => {\n        // Limpiamos los nombres de las columnas para usarlos como claves\n        const cleanKey = key.trim().replace(/\\s+/g, '_');\n        rowObject[cleanKey] = row[i] || null;\n      });\n      rowObject.__ROW_NUMBER__ = index + 2; // Guardamos el n\xfamero de fila original\n      return rowObject;\n    });\n\n    res.status(200).json(validRows);\n  } catch (error) {\n    console.error('Error al leer Google Sheet:', error);\n    res.status(500).send('Error interno al procesar el archivo de Google Sheets.');\n  }\n});\n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);